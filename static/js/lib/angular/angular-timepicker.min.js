!function(e){"use strict";e.module("dnTimepicker",["ui.bootstrap.position","dateParser"]).factory("dnTimepickerHelpers",function(){return{stringToMinutes:function(e){if(!e)return null;var t=e.match(/(\d+)(h?)/);return t[1]?t[1]*(t[2]?60:1):null},buildOptionList:function(t,i,n){for(var r=[],o=e.copy(t);i>=o;)r.push(new Date(o)),o.setMinutes(o.getMinutes()+n);return r},getClosestIndex:function(t,i){if(!e.isDate(t))return-1;for(var n=null,r=-1,o=60*t.getHours()+t.getMinutes(),c=0;c<i.length;c++){var s=i[c],p=60*s.getHours()+s.getMinutes();(null===n||Math.abs(p-o)<Math.abs(n-o))&&(n=p,r=c)}return r}}}).directive("dnTimepicker",["$compile","$parse","$position","$document","dateFilter","$dateParser","dnTimepickerHelpers","$log",function(t,i,n,r,o,c,s,p){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},link:function(i,a,u,m){function l(e){var t=e.match(/(\d+)(h?)/);return t[1]*(t[2]?60:1)}function d(t){return k||(k=e.isDate(i.ngModel)?i.ngModel:new Date),k.setHours(t.getHours()),k.setMinutes(t.getMinutes()),k.setSeconds(t.getSeconds()),f(k),k}function f(t){e.isDate(t)||(t=c(i.ngModel,i.timepicker.timeFormat),isNaN(t)&&p.warn("Failed to parse model.")),k=t}var k=null,v=!0;i.stringToDate=function(e){if(!e)return null;var t=new Date,i=e.match(/(\d+)(?::(\d\d))?\s*(p|a?)/i);if(!i)return null;var n=parseInt(i[1]);return t.setHours(n+(12==n?i[3]?"p"==i[3].toLowerCase()?0:-12:0:"p"==i[3].toLowerCase()?12:0)),t.setMinutes(parseInt(i[2])||0),t.setSeconds(0),t},i.buildTimeList=function(e,t,i){for(var n=[],r=e;t>=r;)n.push(new Date(r)),r.setMinutes(r.getMinutes()+i);return n};var g=i.stringToDate(u.minTime||i.stringToDate("00:00")),T=i.stringToDate(u.maxTime||i.stringToDate("23:59")),$=l(u.step||"15m");i.timepicker={element:null,timeFormat:"h:mm a",isOpen:!1,activeIdx:-1,optionList:i.buildTimeList(g,T,$)},u.$observe("dnTimepicker",function(e){e&&(i.timepicker.timeFormat=e),m.$render()}),u.$observe("minTime",function(e){e&&(i.timepicker.minTime=c(e,i.timepicker.timeFormat),v=!0)}),u.$observe("maxTime",function(e){e&&(i.timepicker.maxTime=c(e,i.timepicker.timeFormat),v=!0)}),u.$observe("step",function(e){if(e){var t=s.stringToMinutes(e);t&&(i.timepicker.step=t),v=!0}}),i.$watch("ngModel",function(e){f(e?e:new Date),m.$render()}),m.$render=function(){a.val(e.isDate(k)?o(k,i.timepicker.timeFormat):m.$viewValue?m.$viewValue:"")},m.$parsers.unshift(function(t){var n=e.isDate(t)?t:c(t,i.timepicker.timeFormat);return isNaN(n)?void m.$setValidity("time",!1):(m.$setValidity("time",!0),d(n))}),i.select=function(t){e.isDate(t)&&(m.$setViewValue(d(t)),m.$render())},i.isActive=function(e){return e===i.timepicker.activeIdx},i.setActive=function(e){i.timepicker.activeIdx=e},i.scrollToSelected=function(){if(i.timepicker.element&&i.timepicker.activeIdx>-1){var e=i.timepicker.element[0].querySelector(".active");e.parentNode.scrollTop=e.offsetTop-50}},i.openPopup=function(){i.position=n.position(a),i.position.top=i.position.top+a.prop("offsetHeight"),i.timepicker.isOpen=!0,i.timepicker.activeIdx=s.getClosestIndex(i.ngModel,i.timepicker.optionList),i.$digest(),i.scrollToSelected()},i.closePopup=function(){i.timepicker.isOpen&&(i.timepicker.isOpen=!1,i.$apply(),a[0].blur())},a.after(t(e.element("<div dn-timepicker-popup></div>"))(i)),a.bind("focus",function(){i.openPopup()}).bind("keypress keyup",function(e){38===e.which&&i.timepicker.activeIdx>0?(i.timepicker.activeIdx--,i.scrollToSelected()):40===e.which&&i.timepicker.activeIdx<i.timepicker.optionList.length-1?(i.timepicker.activeIdx++,i.scrollToSelected()):13===e.which&&i.timepicker.activeIdx>-1&&(i.select(i.timepicker.optionList[i.timepicker.activeIdx]),i.closePopup()),i.$digest()}),r.bind("click",function(e){i.timepicker.isOpen&&e.target!==a[0]&&i.closePopup()})}}}]).directive("dnTimepickerPopup",[function(){return{restrict:"A",replace:!0,transclude:!1,template:'<ul class="dn-timepicker-popup dropdown-menu" ng-style="{display: timepicker.isOpen && \'block\' || \'none\', top: position.top+\'px\', left: position.left+\'px\'}"><li ng-repeat="time in timepicker.optionList" ng-class="{active: isActive($index) }" ng-mouseenter="setActive($index)" ng-click="select(time)"><a>{{time | date:timepicker.timeFormat}}</a></li></ul>',link:function(e,t,i){e.timepicker.element=t,t.find("a").bind("click",function(e){e.preventDefault()})}}}])}(angular);